# üéØ Patr√≥n de Migraci√≥n: ct_localidad.controller.ts

## ‚úÖ Controlador Migrado Exitosamente

Hemos migrado el controlador de `ct_localidad` como **template** para replicar en los dem√°s controladores.

---

## üìã Cambios Realizados (Paso a Paso)

### **Cambio 1: Agregar Imports Necesarios**

**AGREGAR** estas importaciones al inicio del archivo:

```typescript
import { RequestAutenticado } from "../middleware/authMiddleware";
import {
  obtenerIdSesionDesdeJwt,
  obtenerIdUsuarioDesdeJwt,
} from "../utils/bitacoraUtils";
```

**Ubicaci√≥n:** Despu√©s de `import { Request, Response } from "express";`

---

### **Cambio 2: M√©todo `crear` (CREATE)**

#### ‚ú® Firma del M√©todo

**ANTES:**

```typescript
crearLocalidad = async (req: Request, res: Response): Promise<void> => {
```

**DESPU√âS:**

```typescript
crearLocalidad = async (
  req: RequestAutenticado,  // üîê Cambio de Request a RequestAutenticado
  res: Response
): Promise<void> => {
```

#### ‚ú® Contenido del M√©todo

**ANTES:**

```typescript
await this.manejarCreacion(
  req,
  res,
  async () => {
    const localidadData: CrearCtLocalidadInput = req.body;
    return await ctLocalidadBaseService.crear(localidadData);
  },
  "Localidad creada exitosamente"
);
```

**DESPU√âS:**

```typescript
await this.manejarCreacion(
  req,
  res,
  async () => {
    // üîê AGREGAR: Extraer id_sesion desde JWT
    const idSesion = obtenerIdSesionDesdeJwt(req);

    const localidadData: CrearCtLocalidadInput = req.body;

    // üîê AGREGAR: Pasar idSesion como segundo par√°metro
    return await ctLocalidadBaseService.crear(localidadData, idSesion);
  },
  "Localidad creada exitosamente"
);
```

#### üéØ Resumen del Cambio

1. Cambiar `Request` ‚Üí `RequestAutenticado`
2. Agregar `const idSesion = obtenerIdSesionDesdeJwt(req);`
3. Pasar `idSesion` como segundo par√°metro al servicio

---

### **Cambio 3: M√©todo `actualizar` (UPDATE)**

#### ‚ú® Firma del M√©todo

**ANTES:**

```typescript
actualizarLocalidad = async (req: Request, res: Response): Promise<void> => {
```

**DESPU√âS:**

```typescript
actualizarLocalidad = async (
  req: RequestAutenticado,  // üîê Cambio de Request a RequestAutenticado
  res: Response
): Promise<void> => {
```

#### ‚ú® Contenido del M√©todo

**ANTES:**

```typescript
await this.manejarActualizacion(
  req,
  res,
  async () => {
    const { id_ct_localidad } = this.validarDatosConEsquema<CtLocalidadIdParam>(
      ctLocalidadIdParamSchema,
      req.params
    );
    const localidadData: ActualizarCtLocalidadInput = req.body;

    return await ctLocalidadBaseService.actualizar(
      id_ct_localidad,
      localidadData
    );
  },
  "Localidad actualizada exitosamente"
);
```

**DESPU√âS:**

```typescript
await this.manejarActualizacion(
  req,
  res,
  async () => {
    // üîê AGREGAR: Extraer id_sesion desde JWT
    const idSesion = obtenerIdSesionDesdeJwt(req);

    const { id_ct_localidad } = this.validarDatosConEsquema<CtLocalidadIdParam>(
      ctLocalidadIdParamSchema,
      req.params
    );
    const localidadData: ActualizarCtLocalidadInput = req.body;

    // üîê AGREGAR: Pasar idSesion como tercer par√°metro
    return await ctLocalidadBaseService.actualizar(
      id_ct_localidad,
      localidadData,
      idSesion
    );
  },
  "Localidad actualizada exitosamente"
);
```

#### üéØ Resumen del Cambio

1. Cambiar `Request` ‚Üí `RequestAutenticado`
2. Agregar `const idSesion = obtenerIdSesionDesdeJwt(req);`
3. Pasar `idSesion` como **tercer par√°metro** al servicio

---

### **Cambio 4: M√©todo `eliminar` (DELETE)**

#### ‚ú® Firma del M√©todo

**ANTES:**

```typescript
eliminarLocalidad = async (
  req: Request,
  res: Response
): Promise<void> => {
```

**DESPU√âS:**

```typescript
eliminarLocalidad = async (
  req: RequestAutenticado,  // üîê Cambio de Request a RequestAutenticado
  res: Response
): Promise<void> => {
```

#### ‚ú® Contenido del M√©todo

**ANTES:**

```typescript
await this.manejarEliminacion(
  req,
  res,
  async () => {
    const { id_ct_localidad } = this.validarDatosConEsquema<CtLocalidadIdParam>(
      ctLocalidadIdParamSchema,
      req.params
    );

    const { id_ct_usuario_up } =
      this.validarDatosConEsquema<EliminarCtLocalidadInput>(
        eliminarCtLocalidadSchema,
        req.body
      );

    await ctLocalidadBaseService.eliminar(id_ct_localidad, id_ct_usuario_up);
  },
  "Localidad eliminada exitosamente"
);
```

**DESPU√âS:**

```typescript
await this.manejarEliminacion(
  req,
  res,
  async () => {
    // üîê AGREGAR: Extraer id_sesion e id_usuario desde JWT
    const idSesion = obtenerIdSesionDesdeJwt(req);
    const idUsuario = obtenerIdUsuarioDesdeJwt(req);

    const { id_ct_localidad } = this.validarDatosConEsquema<CtLocalidadIdParam>(
      ctLocalidadIdParamSchema,
      req.params
    );

    // üîê ELIMINAR: Ya no necesitamos obtener id_ct_usuario_up del body
    // const { id_ct_usuario_up } = this.validarDatosConEsquema<EliminarCtLocalidadInput>(...);

    // üîê CAMBIAR: Pasar idUsuario e idSesion como par√°metros
    await ctLocalidadBaseService.eliminar(id_ct_localidad, idUsuario, idSesion);
  },
  "Localidad eliminada exitosamente"
);
```

#### üéØ Resumen del Cambio

1. Cambiar `Request` ‚Üí `RequestAutenticado`
2. Agregar `const idSesion = obtenerIdSesionDesdeJwt(req);`
3. Agregar `const idUsuario = obtenerIdUsuarioDesdeJwt(req);`
4. **ELIMINAR** la validaci√≥n de `id_ct_usuario_up` del body
5. Cambiar llamada al servicio: `.eliminar(id, idUsuario, idSesion)`

---

### **Cambio 5: M√©todos de Lectura (GET)**

**‚úÖ NO REQUIEREN CAMBIOS**

Los m√©todos de lectura **NO necesitan** ser modificados:

- `obtenerLocalidadPorId` ‚úÖ Sin cambios
- `obtenerTodasLasLocalidades` ‚úÖ Sin cambios

**Raz√≥n:** Los m√©todos de lectura no modifican datos, por lo tanto no necesitan bit√°cora ni validaci√≥n de sesi√≥n.

---

## üîÑ F√≥rmula para Replicar en Otros Controladores

### üìù Checklist por Controlador

Para cada controlador que uses como base:

#### ‚úÖ Paso 1: Imports (Una vez por archivo)

```typescript
import { RequestAutenticado } from "../middleware/authMiddleware";
import {
  obtenerIdSesionDesdeJwt,
  obtenerIdUsuarioDesdeJwt,
} from "../utils/bitacoraUtils";
```

#### ‚úÖ Paso 2: M√©todo `crear`

- [ ] Cambiar `req: Request` ‚Üí `req: RequestAutenticado`
- [ ] Agregar `const idSesion = obtenerIdSesionDesdeJwt(req);`
- [ ] Cambiar: `service.crear(datos)` ‚Üí `service.crear(datos, idSesion)`

#### ‚úÖ Paso 3: M√©todo `actualizar`

- [ ] Cambiar `req: Request` ‚Üí `req: RequestAutenticado`
- [ ] Agregar `const idSesion = obtenerIdSesionDesdeJwt(req);`
- [ ] Cambiar: `service.actualizar(id, datos)` ‚Üí `service.actualizar(id, datos, idSesion)`

#### ‚úÖ Paso 4: M√©todo `eliminar`

- [ ] Cambiar `req: Request` ‚Üí `req: RequestAutenticado`
- [ ] Agregar `const idSesion = obtenerIdSesionDesdeJwt(req);`
- [ ] Agregar `const idUsuario = obtenerIdUsuarioDesdeJwt(req);`
- [ ] Eliminar validaci√≥n de `id_ct_usuario_up` del body
- [ ] Cambiar: `service.eliminar(id)` ‚Üí `service.eliminar(id, idUsuario, idSesion)`

---

## üé® Template Visual de Cambios

```typescript
// ==========================================
// TEMPLATE: M√âTODO CREAR
// ==========================================
nombreMetodo = async (
  req: RequestAutenticado, // ‚Üê CAMBIO 1
  res: Response
): Promise<void> => {
  await this.manejarCreacion(
    req,
    res,
    async () => {
      const idSesion = obtenerIdSesionDesdeJwt(req); // ‚Üê CAMBIO 2

      const datos = req.body;
      return await service.crear(datos, idSesion); // ‚Üê CAMBIO 3: Agregar idSesion
    },
    "Mensaje exitoso"
  );
};

// ==========================================
// TEMPLATE: M√âTODO ACTUALIZAR
// ==========================================
nombreMetodo = async (
  req: RequestAutenticado, // ‚Üê CAMBIO 1
  res: Response
): Promise<void> => {
  await this.manejarActualizacion(
    req,
    res,
    async () => {
      const idSesion = obtenerIdSesionDesdeJwt(req); // ‚Üê CAMBIO 2

      const id = parseInt(req.params.id);
      const datos = req.body;

      return await service.actualizar(id, datos, idSesion); // ‚Üê CAMBIO 3
    },
    "Mensaje exitoso"
  );
};

// ==========================================
// TEMPLATE: M√âTODO ELIMINAR
// ==========================================
nombreMetodo = async (
  req: RequestAutenticado, // ‚Üê CAMBIO 1
  res: Response
): Promise<void> => {
  await this.manejarEliminacion(
    req,
    res,
    async () => {
      const idSesion = obtenerIdSesionDesdeJwt(req); // ‚Üê CAMBIO 2
      const idUsuario = obtenerIdUsuarioDesdeJwt(req); // ‚Üê CAMBIO 3

      const id = parseInt(req.params.id);

      // ‚ö†Ô∏è ELIMINAR: const { id_ct_usuario_up } = ...del body

      await service.eliminar(id, idUsuario, idSesion); // ‚Üê CAMBIO 4
    },
    "Mensaje exitoso"
  );
};
```

---

## üöÄ Ejemplo de Aplicaci√≥n en Otro Controlador

### ct_municipio.controller.ts

Aplicando el mismo patr√≥n:

```typescript
// 1. Agregar imports
import { RequestAutenticado } from "../middleware/authMiddleware";
import {
  obtenerIdSesionDesdeJwt,
  obtenerIdUsuarioDesdeJwt,
} from "../utils/bitacoraUtils";

// 2. M√©todo crear
crearMunicipio = async (
  req: RequestAutenticado, // ‚úÖ
  res: Response
): Promise<void> => {
  await this.manejarCreacion(
    req,
    res,
    async () => {
      const idSesion = obtenerIdSesionDesdeJwt(req); // ‚úÖ
      const municipioData = req.body;
      return await municipioService.crear(municipioData, idSesion); // ‚úÖ
    },
    "Municipio creado exitosamente"
  );
};

// 3. M√©todo actualizar
actualizarMunicipio = async (
  req: RequestAutenticado, // ‚úÖ
  res: Response
): Promise<void> => {
  await this.manejarActualizacion(
    req,
    res,
    async () => {
      const idSesion = obtenerIdSesionDesdeJwt(req); // ‚úÖ
      const id = parseInt(req.params.id);
      const municipioData = req.body;
      return await municipioService.actualizar(id, municipioData, idSesion); // ‚úÖ
    },
    "Municipio actualizado exitosamente"
  );
};

// 4. M√©todo eliminar
eliminarMunicipio = async (
  req: RequestAutenticado, // ‚úÖ
  res: Response
): Promise<void> => {
  await this.manejarEliminacion(
    req,
    res,
    async () => {
      const idSesion = obtenerIdSesionDesdeJwt(req); // ‚úÖ
      const idUsuario = obtenerIdUsuarioDesdeJwt(req); // ‚úÖ
      const id = parseInt(req.params.id);
      await municipioService.eliminar(id, idUsuario, idSesion); // ‚úÖ
    },
    "Municipio eliminado exitosamente"
  );
};
```

---

## ‚ö° Atajos de B√∫squeda y Reemplazo (VSCode)

Para acelerar la migraci√≥n, usa estos patrones de b√∫squeda en VSCode:

### Buscar:

```regex
async crear\w+\s*=\s*async\s*\(req:\s*Request
```

### Reemplazar con:

```typescript
async crear = async (req: RequestAutenticado
```

### Buscar:

```regex
async actualizar\w+\s*=\s*async\s*\(req:\s*Request
```

### Reemplazar con:

```typescript
async actualizar = async (req: RequestAutenticado
```

### Buscar:

```regex
async eliminar\w+\s*=\s*async\s*\(req:\s*Request
```

### Reemplazar con:

```typescript
async eliminar = async (req: RequestAutenticado
```

---

## üéØ Lista de Controladores por Migrar

Aplica este mismo patr√≥n a estos controladores:

### ‚úÖ Cat√°logos Generales (3 archivos):

- [x] `ct_localidad.controller.ts` ‚Üê **‚úÖ COMPLETADO (Template)**
- [ ] `ct_municipio.controller.ts`
- [ ] `ct_entidad.controller.ts`

### üìä Bit√°cora (3 archivos):

- [ ] `ct_bitacora_accion.controller.ts`
- [ ] `ct_bitacora_tabla.controller.ts`
- [ ] `dt_bitacora.controller.ts`

### üèóÔ∏è Infraestructura (11 archivos):

- [ ] `ct_infraestructura_anexo.controller.ts`
- [ ] `ct_infraestructura_area.controller.ts`
- [ ] `ct_infraestructura_departamento.controller.ts`
- [ ] `ct_infraestructura_direccion.controller.ts`
- [ ] `ct_infraestructura_escuela.controller.ts`
- [ ] `ct_infraestructura_jefe_sector.controller.ts`
- [ ] `ct_infraestructura_sostenimiento.controller.ts`
- [ ] `ct_infraestructura_supervisor.controller.ts`
- [ ] `ct_infraestructura_tipo_escuela.controller.ts`
- [ ] `ct_infraestructura_tipo_instancia.controller.ts`
- [ ] `dt_infraestructura_ubicacion.controller.ts`

### üì¶ Inventario (11 archivos):

- [ ] `ct_inventario_alta.controller.ts`
- [ ] `ct_inventario_baja.controller.ts`
- [ ] `ct_inventario_clase.controller.ts`
- [ ] `ct_inventario_color.controller.ts`
- [ ] `ct_inventario_estado_fisico.controller.ts`
- [ ] `ct_inventario_marca.controller.ts`
- [ ] `ct_inventario_material.controller.ts`
- [ ] `ct_inventario_proveedor.controller.ts`
- [ ] `ct_inventario_subclase.controller.ts`
- [ ] `ct_inventario_tipo_articulo.controller.ts`
- [ ] `dt_inventario_articulo.controller.ts`

---

## üéâ ¬°Listo para Replicar!

Ahora tienes el patr√≥n completo. Para cada controlador:

1. Abre el archivo
2. Agrega los imports
3. Busca m√©todo `crear` ‚Üí Aplica patr√≥n
4. Busca m√©todo `actualizar` ‚Üí Aplica patr√≥n
5. Busca m√©todo `eliminar` ‚Üí Aplica patr√≥n
6. Guarda y verifica compilaci√≥n

**Tiempo estimado por controlador: 2-3 minutos** ‚ö°

üöÄ ¬°Comienza con los m√°s simples y ve avanzando!
